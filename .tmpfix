#!/usr/bin/env python3
"""
Супер простий патч для тимчасових директорій.
Для використання скопіюйте і запустіть ці команди:

import os, subprocess
subprocess.check_call(['python', os.path.join(os.getcwd(), '.tmpfix')])
"""
import os
import sys

print("TMP FIX: Running...")

# Створюємо локальну тимчасову директорію
tmp_dir = os.path.join(os.getcwd(), '.tmp')
os.makedirs(tmp_dir, exist_ok=True)
print(f"TMP FIX: Created directory {tmp_dir}")

# Встановлюємо змінні середовища
os.environ['TMPDIR'] = tmp_dir
os.environ['TMP'] = tmp_dir
os.environ['TEMP'] = tmp_dir
print("TMP FIX: Set environment variables")

# Патчимо tempfile в батьківському процесі
print("TMP FIX: Creating Python code for parent process")

# Створюємо код для запуску в батьківському процесі
patch_code = f'''
import os, tempfile
tmp_dir = "{tmp_dir}"
os.environ['TMPDIR'] = tmp_dir
os.environ['TMP'] = tmp_dir
os.environ['TEMP'] = tmp_dir
tempfile.tempdir = tmp_dir
orig_gettempdir = tempfile.gettempdir
def new_gettempdir():
    return tmp_dir
tempfile.gettempdir = new_gettempdir
print("TMP FIX: Patched tempfile in parent process")
'''

# Записуємо його в тимчасовий файл
parent_patch = os.path.join(tmp_dir, 'parent_patch.py')
with open(parent_patch, 'w') as f:
    f.write(patch_code)

print(f"TMP FIX: To apply in your code, add this at the very beginning:")
print("import os, subprocess")
print(f"subprocess.check_call(['python', '{os.path.join(os.getcwd(), '.tmpfix')}'])")
print("exec(open(os.path.join(os.getcwd(), '.tmp/parent_patch.py')).read())")

# Тестуємо
try:
    import tempfile
    tempfile.tempdir = tmp_dir
    fd, path = tempfile.mkstemp()
    os.close(fd)
    os.unlink(path)
    print(f"TMP FIX: Test successful, using {tmp_dir}")
except Exception as e:
    print(f"TMP FIX: Test failed: {e}")

print("TMP FIX: Done") 